!function(a){function b(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d}function c(a,c,d){var e={distSq:b(c,d),value:d},f=_.sortedIndex(a,e,"distSq");a.splice(f,0,e)}a.Util={override:function(a,b,c){var d=a[b];a[b]=function(){var a=this.__super;this.__super=d,c.apply(this,arguments),this.__super=a}},distanceFrom:function(a,b){var d=[];return function e(f){f instanceof Phaser.Group?b.forEach(e,!0):f&&c(d,a,f)}(b),d},findClosest:function(a,b,c){void 0===c&&(c=1);var d=Util.distanceFrom(a,b),e=_(d).first(c).map(function(a){return{distance:Math.sqrt(a.distSq),value:a.value}}).valueOf();return 1===c?e[0]:e}}}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,0,0,"command-icons"),this.animations.add("selected",[c]),this.animations.add("unselected",[d]),this.animations.play("unselected"),this._selected=!1,this.command=b}function c(a){Phaser.Group.call(this,a),this.icons={move:this.addIcon("move",1,0),attack:this.addIcon("attack",3,2),defend:this.addIcon("defend",5,4),stop:this.addIcon("stop",6,6)},this.events=new Phaser.Events,_.extend(this.events,{onIconSelected:new Phaser.Signal,onIconDeselected:new Phaser.Signal})}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,Object.defineProperty(b.prototype,"selected",{get:function(){return this._selected},set:function(a){var b=!!a;b!=this._selected&&(this._selected=b,this.animations.play(this._selected?"selected":"unselected"))}}),c.prototype=Object.create(Phaser.Group.prototype),c.prototype.constructor=c,c.preload=function(a){a.spritesheet("command-icons","assets/command icons.e8c7eff5.png",64,64)},_.extend(c.prototype,{addIcon:function(a,c,d){var e=new b(this.game,a,c,d);return e.inputEnabled=!0,e.events.onInputDown.add(this.onIconClicked,this),e.kill(),this.add(e),e},display:function(){this.callAll("kill");var a=_.flatten(arguments),b=0;_.each(a,function(a){var c=this.icons[a];c&&c.reset(b,0),b+=96},this)},onIconClicked:function(a){this.selectedIcon&&this.selectedIcon!=a&&(this.events.onIconDeselected.dispatch(this.selectedIcon.command),this.selectedIcon.selected=!1),a.selected?(this.events.onIconDeselected.dispatch(a.command),a.selected=!1,this.selectedIcon=null):(this.events.onIconSelected.dispatch(a.command),a.selected=!0,this.selectedIcon=a)},clearSelection:function(){this.selectedIcon&&(this.events.onIconDeselected.dispatch(this.selectedIcon.command),this.selectedIcon.selected=!1,this.selectedIcon=null)},clear:function(){this.clearSelection(),this.display()}}),a.IconBar=c}(this),function(a){function b(a,c,d){Phaser.TileSprite.call(this,a,c,0,8,a.world.height,b.commandToKey[d]),this.anchor.setTo(.5,0)}b.prototype=Object.create(Phaser.TileSprite.prototype),b.prototype.constructor=b,b.commandToKey={move:"command-indicator-green",attack:"command-indicator-red",defend:"command-indicator-blue"},b.preload=function(a){a.image("command-indicator-red","assets/vertical red.b90905c2.png"),a.image("command-indicator-blue","assets/vertical blue.b66fa825.png"),a.image("command-indicator-green","assets/vertical green.916d36c6.png")},a.CommandIndicator=b}(this),function(a){function b(a){this.game=a,this.units=[],this.shiftKey=a.input.keyboard.addKey(Phaser.Keyboard.SHIFT),this.events={onSelectionChange:new Phaser.Signal}}b.prototype={onInputDown:function(a){var b,c,d=this.shiftKey.isDown;a.selected?d||1===this.units.length&&this.units[0]===a?c=this.remove(a):(c=this.remove(_.without(this.units,a)),b=this.add(a)):(d||(c=this.remove(_.without(this.units,a))),b=this.add(a)),this.events.onSelectionChange.dispatch(this.units.slice(),b,c)},onClickBackdrop:function(){var a=this.remove(this.units);this.events.onSelectionChange.dispatch(this.units.slice(),[],a)},add:function(){var a=[];return _(arguments).flatten().each(function(b){b.selected||(b.selected=!0);var c=this.units.indexOf(b);0>c&&(this.units.push(b),a.push(b))},this),a},remove:function(){var a=[];return _(arguments).flatten().each(function(b){b.selected&&(b.selected=!1);var c=this.units.indexOf(b);c>=0&&(this.units.splice(c,1),a.push(b))},this),a},forEach:function(a,b){_.each(this.units,a,b)}},a.SelectionManager=b}(this),function(a){function b(a,b){this.game=a,this.iconBar=b,this.commands={},this.activeCommand=null,this.events={onStartCommand:new Phaser.Signal,onEndCommand:new Phaser.Signal}}function c(a){return _(a).pluck("commands").flatten().unique().sortBy(function(a){return d[a]||-1}).valueOf()}_.extend(b.prototype,{add:function(a,b){this.commands[a]=b},update:function(){var a=this.activeCommand;a&&a.update()},onSelectionChange:function(a){if(this.selection=a,this.iconBar.clear(),_.isEmpty(a));else{var b=c(a);this.iconBar.display(b)}},onIconSelected:function(a){var b=this.commands[a];b&&(this.events.onStartCommand.dispatch(a),this.activeCommand&&this.activeCommand.cancel(),this.activeCommand=b,b.start(_.once(function(b,c,d){b?console.log(b):_.forEach(this.selection,c,d),this.activeCommand=null,this.iconBar.clearSelection(),this.events.onEndCommand.dispatch(a,b)}.bind(this))))},onIconDeselected:function(a){var b=this.activeCommand;b&&this.commands[a]===b&&(b.cancel(),this.activeCommand=null)}});var d={back:0,move:1,attack:2,defend:3,rally:4,stop:5};a.CommandManager=b}(this),function(a){function b(a,b){this.game=a,this.command=b}b.prototype={start:function(a){this.callback=a;var b=this.indicator=new CommandIndicator(this.game,0,this.command);this.game.add.existing(b),this.game.input.onDown.addOnce(this.onDown,this)},update:function(){this.indicator&&(this.indicator.x=this.game.input.mousePointer.worldX)},cancel:function(){this.destroyIndicator(),this.game.input.onDown.remove(this.onDown,this)},onDown:function(){var a=this.game.input.mousePointer.worldX;this.destroyIndicator(),this.callback(null,function(b){b.send({command:this.command,target:a})},this)},destroyIndicator:function(){this.indicator&&(this.indicator.destroy(),this.indicator=null)}},a.PickXCoordCommand=b}(this),function(a){function b(){}b.prototype={start:function(a){a(null,function(a){a.send({command:"stop"})})}},a.StopCommand=b}(this),function(a){function b(a){Phaser.Sprite.call(this,a,0,0,"invisible"),this.width=a.world.width,this.height=a.world.height,this.inputEnabled=!0,this.bubble=!0,this.changeBubble=!1,this.fixedToCamera=!0,this.events.onClickBackdrop=new Phaser.Signal,this.events.onInputDown.add(function(){console.log("click"),this.bubble&&this.events.onClickBackdrop.dispatch()},this)}b.preload=function(a){a.image("invisible","assets/transparent white.befc4a78.png")},b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{update:function(){this.changeBubble&&(this.bubble=!this.bubble,this.changeBubble=!1)},onStartCommand:function(){this.bubble=!1},onEndCommand:function(){this.changeBubble=!0}}),a.Backdrop=b}(this),function(a){function b(a,b,c){Phaser.Sprite.call(this,a,b,c,"health-bar"),this.frame=0}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.preload=function(a){a.spritesheet("health-bar","assets/health bar.9bea7ae7.png",32,8)},_.extend(b.prototype,{setHp:function(a,b){var c=a/b;this.frame=.25>=c?3:.5>=c?2:.75>=c?1:0}}),a.HealthBar=b}(this),function(a){function b(a){return function(b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b[c]&&"function"==typeof d?Util.override(b,c,d):b[c]=d}}}a.Mixin={create:b}}(this),function(a){var b={WALK_RATE:6,FALL_RATE:12,DEFAULT_WALK_SPEED:50,DEFAULT_JUMP_SPEED:-220,init:function(){this.animations.add("stand",[1]),this.animations.add("face-left",[4]),this.animations.add("face-right",[7]),this.animations.add("walk-left",[3,4,5,4],b.WALK_RATE,!0),this.animations.add("walk-right",[6,7,8,7],b.WALK_RATE,!0),this.animations.add("falling",[1,4,10,7],b.FALL_RATE,!0),this.animations.play("stand"),game.physics.enable(this,Phaser.Physics.ARCADE),this.anchor.setTo(.5,.5),this.body.collideWorldBounds=!0,this.body.acceleration.y=350},setHp:function(a,b){void 0!==b&&(this.maxHp=Math.max(1,b)),this.currHp=Math.min(a||0,this.maxHp),this.healthBar.setHp(this.currHp,this.maxHp)},updateState:function(){switch(this.state){case"standing":if(this.body.onFloor()){this.body.velocity.x=0;var a=this.destination();if(void 0!==a){var b=a>this.body.x?Phaser.RIGHT:Phaser.LEFT;this.walk(b)}}else this.fall();break;case"walking":if(this.body.onFloor()){var c=this.destination();void 0!==c?this.dir==Phaser.LEFT?c>this.body.x?this.walk(Phaser.RIGHT):this.body.blocked.left&&this.jump():this.dir==Phaser.RIGHT&&(c<this.body.x?this.walk(Phaser.LEFT):this.body.blocked.right&&this.jump()):"none"===this.activity&&this.stand()}else this.fall();break;case"falling":this.body.onFloor()&&this.stand();break;case"jumping":if(this.body.velocity.y>0)this.fall();else{var c=this.destination();void 0!==c&&(c<this.body.x?this.left():c>this.body.y&&this.right())}}},jump:function(){this.state="jumping",this.body.velocity.y=this.jumpSpeed||b.DEFAULT_JUMP_SPEED},left:function(){this.body.velocity.x=-(this.walkSpeed||b.DEFAULT_WALK_SPEED),this.dir=Phaser.LEFT},right:function(){this.dir=Phaser.RIGHT,this.body.velocity.x=this.walkSpeed||b.DEFAULT_WALK_SPEED},stand:function(){switch(this.state="standing",this.dir){case Phaser.LEFT:this.animations.play("face-left");break;case Phaser.RIGHT:this.animations.play("face-right");break;default:this.animations.play("stand")}},fall:function(){this.state="falling"},walk:function(a){switch(a){case Phaser.LEFT:this.state="walking",this.animations.play("walk-left"),this.left();break;case Phaser.RIGHT:this.state="walking",this.animations.play("walk-right"),this.right()}}};a.Mixin.humanoid=Mixin.create(b)}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,b,c,d)}b.preload=function(a){a.image("1x1-select-box","assets/1x1 selected.fef6b915.png")},b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{createSelectBox:function(){var a=this.selectBox=game.make.sprite(0,0,"1x1-select-box");a.anchor.setTo(.5,.5),a.smoothed=!1,a.visible=!1,this.addChild(a)},createHealthBar:function(){var a=this.height/2,b=this.healthBar=new HealthBar(this.game,0,-a);b.anchor.setTo(.5,1),b.smoothed=!1,b.visible=!1,this.addChild(b)},setHp:function(a,b){void 0!==b&&(this.maxHp=Math.max(1,b)),this.currHp=Math.min(a||0,this.maxHp),this.healthBar.setHp(this.currHp,this.maxHp)},send:function(a){this.onMessage&&this.onMessage(a)},onMessage:function(a){console.log(a)}}),Object.defineProperty(b.prototype,"selected",{get:function(){return this.selectBox.visible},set:function(a){return this.healthBar.visible=this.selectBox.visible=!!a}}),a.Unit=b}(this),function(a){function b(a,b,c,d,e){Unit.call(this,a,b,c,d),this.init(),this.inputEnabled=!0,this.createSelectBox(32,32),this.createHealthBar(),this.activity="none",this.dir=Phaser.NONE,this.blood=e,this.fall()}b.SEEK_TOLERANCE=4,b.prototype=Object.create(Unit.prototype),b.prototype.constructor=b,Mixin.humanoid(b.prototype),_.extend(b.prototype,{think:function(){switch(this.activity){case"seeking":Math.abs(this.target-this.body.x)<b.SEEK_TOLERANCE&&(this.dir=Phaser.NONE,this.stand(),this.activity="none")}this.updateState()},destination:function(){return"seeking"===this.activity?this.target:void 0},damage:function(a){this.currHp-=a,this.healthBar.setHp(this.currHp,this.maxHp);var b=this.x,c=this.y;this.currHp<=0?(this.blood.gush(b,c),this.destroy()):this.blood.spray(b,c)},seek:function(a){this.target=a,this.activity="seeking"},onMessage:function(a){a.target&&this.seek(a.target),"stop"===a.command&&(this.activity="none",this.dir=Phaser.NONE,this.target=null)}}),a.Troop=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"knight",e),this.commands=b.COMMANDS,this.setHp(100,100)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","attack","defend","stop"],b.preload=function(a){a.spritesheet("knight","assets/knight.5f1d77ac.png",32,32)},a.Soldier=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"archer",e),this.commands=b.COMMANDS,this.setHp(75,75)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","attack","defend","stop"],b.preload=function(a){a.spritesheet("archer","assets/archer.64e4bc6f.png",32,32)},a.Archer=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"peasant",e),this.commands=b.COMMANDS,this.setHp(40,40)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","stop"],b.preload=function(a){a.spritesheet("peasant","assets/peasant.4599a146.png",32,32)},a.Peasant=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"priest",e),this.commands=b.COMMANDS,this.setHp(30,30)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","stop"],b.preload=function(a){a.spritesheet("priest","assets/priest.b943bb06.png",32,32)},a.Priest=b}(this),function(a){function b(a,c,d,e){var f=e===b.MALE?"male-orc":"female-orc";Phaser.Sprite.call(this,a,c,d,f),this.init(),this.activity="none",this.state="none",this.fall()}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.MALE="male",b.FEMALE="female",b.CLOSE_ENOUGH_X=300,b.CLOSE_ENOUGH_Y=96,b.WITHIN_ATTACK_RANGE=24,b.ATTACK_DAMAGE=40,b.TO_HIT_TIME=200,b.COOLDOWN_TIME=1e3,b.preload=function(a){a.spritesheet("male-orc","assets/gentleman orc.cb00031e.png",32,32),a.spritesheet("female-orc","assets/lady orc.23c865c5.png",32,32)},Mixin.humanoid(b.prototype),_.extend(b.prototype,{setHp:function(a,b){void 0!==b&&(this.maxHp=Math.max(1,b))},think:function(){var a=this.foes;if(a&&"cooling down"!==this.activity){var c=Util.findClosest(this,a);c&&(this.actualClosest=c,Math.abs(this.body.x-c.value.x)<=b.CLOSE_ENOUGH_X&&Math.abs(this.body.y-c.value.y)<=b.CLOSE_ENOUGH_Y&&("hunting"==this.activity||(this.prey=c.value,this.activity="hunting")))}switch(this.activity){case"hunting":this.prey?this.prey.exists?this.body.onFloor()&&this.withinRange(this.prey)&&this.attack():(this.prey=null,this.activity="none"):(console.log("error: hunting nothing"),this.activity="none")}this.updateState()},destination:function(){if("hunting"===this.activity){if(this.prey)return this.prey.x;this.activity="none",console.log("error: hunting nothing")}return void 0},withinRange:function(a){return Math.abs(a.x-this.x)<=b.WITHIN_ATTACK_RANGE&&Math.abs(a.y-this.y)<=2},attack:function(){if(this.prey){var a=this.prey.body.x,c=this.prey.body.y;this.body.x<a?(this.dir=Phaser.RIGHT,this.animations.play("face-right")):this.body.x>a&&(this.dir=Phaser.LEFT,this.animations.play("face-left"));var d=new SlashEffect(this.game,a+16,c+16,this.dir);this.game.add.existing(d),this.game.time.events.add(b.TO_HIT_TIME,function(){this.prey.damage(b.ATTACK_DAMAGE)},this),this.cooldown(b.COOLDOWN_TIME)}else"attacking"===this.activity&&(this.activity="none"),console.log("error: attacking nothing")},cooldown:function(a){this.activity="cooling down",this.stand(),this.game.time.events.add(a,this.wakeUp,this)},wakeUp:function(){"cooling down"===this.activity&&(this.activity="none")}}),a.Orc=b}(this),function(a){function b(a,b){var c=this.emitter=a.add.emitter(0,0,100);c.makeParticles(b),c.gravity=350}b.preload=function(a){a.image("man-blood","assets/manblood.24438e51.png"),a.image("orc-blood","assets/orcblood.5fd1d11b.png")},b.prototype={gush:function(a,b){this.emit(a,b,30)},spray:function(a,b){this.emit(a,b,6)},emit:function(a,b,c){var d=this.emitter;d.x=a,d.y=b,d.start(!0,500,null,c)}},a.BloodSpray=b}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,b,c,"slash-effect"),this.anchor.setTo(.5,.5),d===Phaser.RIGHT&&(this.scale.x=-1),this.animations.add("slash",[0,1,2,3],10),this.animations.play("slash",null,!1,!0)}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.preload=function(a){a.spritesheet("slash-effect","assets/slash.961ea3bd.png",32,32)},a.SlashEffect=b}(this),function(a){function b(a,b,c){this.game=a,this.humans=b,this.orcs=c,this.manblood=new BloodSpray(a,"man-blood"),this.orcblood=new BloodSpray(a,"orc-blood")}function c(a){return 32*a+16}function d(a){return 32*a+16}b.prototype={soldier:function(a,b){var a=d(a),b=c(b);return new Soldier(this.game,a,b,this.manblood)},archer:function(a,b){var a=d(a),b=c(b);return new Archer(this.game,a,b,this.manblood)},peasant:function(a,b){var a=d(a),b=c(b);return new Peasant(this.game,a,b,this.manblood)},priest:function(a,b){var a=d(a),b=c(b);return new Priest(this.game,a,b,this.manblood)},orc:function(a,b){var a=d(a),b=c(b),e=this.game.rnd.pick(["male","female"]),f=new Orc(this.game,a,b,e);return f.foes=this.humans,f}},a.Spawn=b}(this),function(a){function b(){}b.prototype={preload:function(){this.load.image("loading-bar-overlay","assets/loading-bar-overlay.ceb049f0.png"),this.load.image("loading-bar","assets/loading-bar.defc2430.png")},create:function(){this.game.state.start("preloader")}},a.Boot=b}(this),function(a){function b(){}b.FADE_OUT_TIME=250,b.STAY_DARK_TIME=100,b.NEXT_STATE="game",b.prototype={preload:function(){var a=this.load,b=this.add;this.bar=b.sprite(303,281,"loading-bar"),this.overlay=b.sprite(298,276,"loading-bar-overlay"),a.onLoadComplete.addOnce(this.onLoadComplete,this),a.setPreloadSprite(this.bar),Game.preload(a),Unit.preload(a),Soldier.preload(a),Archer.preload(a),Peasant.preload(a),Priest.preload(a),Orc.preload(a),IconBar.preload(a),CommandIndicator.preload(a),Backdrop.preload(a),HealthBar.preload(a),BloodSpray.preload(a),SlashEffect.preload(a)},onLoadComplete:function(){this.add.tween(this.bar).to({alpha:0},b.FADE_OUT_TIME).start().onComplete.addOnce(function(){this.time.events.add(b.STAY_DARK_TIME,function(){this.game.state.start(b.NEXT_STATE)},this)},this),this.add.tween(this.overlay).to({alpha:0},b.FADE_OUT_TIME).start()}},a.Preloader=b}(this),function(a){function b(){}b.SCROLL_MARGIN=50,b.CAMERA_SPEED=10;for(var c={},d=0;34>d;d++)c[d]=d-1;b.preload=function(a){a.tilemap("test-map-0","assets/test-map-1.6b80c2ce.json",void 0,Phaser.Tilemap.TILED_JSON),a.image("placeholder-tiles","assets/placeholder tiles.2c479a50.png")},b.prototype={create:function(){var a=this.add,c=this.game,d=this.game.physics;this.stage.backgroundColor="#6495ED",d.startSystem(Phaser.Physics.ARCADE);var e=this.backdrop=new Backdrop(c);c.add.existing(e);var f=this.map=a.tilemap("test-map-0"),g=this.layer=f.createLayer("terrain");f.addTilesetImage("terrain","placeholder-tiles"),f.setCollisionBetween(2,10,!0),g.resizeWorld();var h=this.iconBar=new IconBar(c);h.x=b.SCROLL_MARGIN,h.y=600-(b.SCROLL_MARGIN+64),h.fixedToCamera=!0;var i=this.selections=new SelectionManager(c),j=this.commands=new CommandManager(c,h);j.add("move",new PickXCoordCommand(c,"move")),j.add("attack",new PickXCoordCommand(c,"attack")),j.add("defend",new PickXCoordCommand(c,"defend")),j.add("stop",new StopCommand),i.events.onSelectionChange.add(j.onSelectionChange,j),h.events.onIconSelected.add(j.onIconSelected,j),h.events.onIconDeselected.add(j.onIconDeselected,j),e.events.onClickBackdrop.add(i.onClickBackdrop,i),j.events.onStartCommand.add(e.onStartCommand,e),j.events.onEndCommand.add(e.onEndCommand,e);var k=this.humans=a.group(),l=this.orcs=a.group();spawn=new Spawn(c,k,l),k.add(spawn.soldier(29,16)),k.add(spawn.archer(36,16)),k.add(spawn.peasant(39,16)),k.add(spawn.priest(40,16)),k.forEach(function(a){a.events.onInputDown.add(i.onInputDown,i)},this),l.add(spawn.orc(24,18)),c.world.bringToTop(h),c.camera.x=1e3,c.camera.y=222},update:function(){var a=this.humans,c=this.orcs,d=this.game.physics,e=this.input.mousePointer.position;e.x<b.SCROLL_MARGIN?this.camera.x+=-b.CAMERA_SPEED:e.x>this.game.width-b.SCROLL_MARGIN&&(this.camera.x+=b.CAMERA_SPEED),e.y<b.SCROLL_MARGIN?this.camera.y+=-b.CAMERA_SPEED:e.y>this.game.height-b.SCROLL_MARGIN&&(this.camera.y+=b.CAMERA_SPEED),d.arcade.collide(a,this.layer),d.arcade.collide(c,this.layer),a.callAll("think"),c.callAll("think"),this.commands.update()},onIconSelected:function(a){console.log('entering "'+a+'"');var b=this.indicator=new CommandIndicator(this.game,0,a);b.fixToInput=!0,game.add.existing(b)},onIconDeselected:function(a){console.log('exiting "'+a+'"'),this.indicator&&(this.indicator.destroy(),this.indicator=null)}},a.Game=b}(this);var game=new Phaser.Game(800,600,Phaser.AUTO,"game-container");game.state.add("boot",Boot),game.state.add("preloader",Preloader),game.state.add("game",Game),game.state.start("boot");