!function(a){function b(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d}function c(a,c,d){var e={distSq:b(c,d),value:d},f=_.sortedIndex(a,e,"distSq");a.splice(f,0,e)}a.Util={override:function(a,b,c){var d=a[b];a[b]=function(){var a=this.__super;this.__super=d;var b=c.apply(this,arguments);return this.__super=a,b}},distanceFrom:function(a,b){var d=[];return function e(f){f instanceof Phaser.Group?b.forEach(e,!0):f&&c(d,a,f)}(b),d},findClosest:function(a,b,c){void 0===c&&(c=1);var d=Util.distanceFrom(a,b),e=_(d).first(c).map(function(a){return{distance:Math.sqrt(a.distSq),value:a.value}}).valueOf();return 1===c?e[0]:e},lobAtPoint:function(a,b,c,d){var e=b.x-a.x,f=b.y-a.y,g=c,h=g*g,i=-d,j=i*e,k=h*h-i*(j*e+2*f*h);if(0>=k)return void 0;var l=Math.sqrt(k),m=Math.atan2(h+l,j)+Math.PI;return a2=Math.atan2(h-l,j)+Math.PI,[m,a2]}}}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,0,0,"command-icons"),this.animations.add("selected",[c]),this.animations.add("unselected",[d]),this.animations.play("unselected"),this._selected=!1,this.command=b}function c(a){Phaser.Group.call(this,a),this.icons={move:this.addIcon("move",1,0),attack:this.addIcon("attack",3,2),defend:this.addIcon("defend",5,4),stop:this.addIcon("stop",6,6),gravityUp:this.addIcon("gravityUp",8,7),gravityDown:this.addIcon("gravityDown",10,9)},this.events=new Phaser.Events,_.extend(this.events,{onIconSelected:new Phaser.Signal,onIconDeselected:new Phaser.Signal})}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,Object.defineProperty(b.prototype,"selected",{get:function(){return this._selected},set:function(a){var b=!!a;b!=this._selected&&(this._selected=b,this.animations.play(this._selected?"selected":"unselected"))}}),c.prototype=Object.create(Phaser.Group.prototype),c.prototype.constructor=c,c.preload=function(a){a.spritesheet("command-icons","assets/command icons.e4aa6814.png",64,64,11)},_.extend(c.prototype,{addIcon:function(a,c,d){var e=new b(this.game,a,c,d);return e.inputEnabled=!0,e.events.onInputDown.add(this.onIconClicked,this),e.kill(),this.add(e),e},display:function(){this.callAll("kill");var a=_.flatten(arguments),b=0;_.each(a,function(a){var c=this.icons[a];c&&c.reset(b,0),b+=96},this)},onIconClicked:function(a){this.selectedIcon&&this.selectedIcon!=a&&(this.events.onIconDeselected.dispatch(this.selectedIcon.command),this.selectedIcon.selected=!1),a.selected?(this.events.onIconDeselected.dispatch(a.command),a.selected=!1,this.selectedIcon=null):(this.events.onIconSelected.dispatch(a.command),a.selected=!0,this.selectedIcon=a)},clearSelection:function(){this.selectedIcon&&(this.events.onIconDeselected.dispatch(this.selectedIcon.command),this.selectedIcon.selected=!1,this.selectedIcon=null)},clear:function(){this.clearSelection(),this.display()}}),a.IconBar=c}(this),function(a){function b(a,c,d){Phaser.TileSprite.call(this,a,c,0,8,a.world.height,b.commandToKey[d]),this.anchor.setTo(.5,0)}b.prototype=Object.create(Phaser.TileSprite.prototype),b.prototype.constructor=b,b.commandToKey={move:"command-indicator-green",attack:"command-indicator-red",defend:"command-indicator-blue"},b.preload=function(a){a.image("command-indicator-red","assets/vertical red.b90905c2.png"),a.image("command-indicator-blue","assets/vertical blue.b66fa825.png"),a.image("command-indicator-green","assets/vertical green.916d36c6.png")},a.CommandIndicator=b}(this),function(a){function b(a){this.game=a,this.units=[],this.shiftKey=a.input.keyboard.addKey(Phaser.Keyboard.SHIFT),this.events={onSelectionChange:new Phaser.Signal}}b.prototype={onInputDown:function(a){var b,c,d=this.shiftKey.isDown;a.selected?d||1===this.units.length&&this.units[0]===a?c=this.remove(a):(c=this.remove(_.without(this.units,a)),b=this.add(a)):(d||(c=this.remove(_.without(this.units,a))),b=this.add(a)),this.events.onSelectionChange.dispatch(this.units.slice(),b,c)},onClickBackdrop:function(){var a=this.remove(this.units);this.events.onSelectionChange.dispatch(this.units.slice(),[],a)},add:function(){var a=[];return _(arguments).flatten().each(function(b){b.selected||(b.selected=!0);var c=this.units.indexOf(b);0>c&&(this.units.push(b),a.push(b))},this),a},remove:function(){var a=[];return _(arguments).flatten().each(function(b){b.selected&&(b.selected=!1);var c=this.units.indexOf(b);c>=0&&(this.units.splice(c,1),a.push(b))},this),a},forEach:function(a,b){_.each(this.units,a,b)}},a.SelectionManager=b}(this),function(a){function b(a,b){this.game=a,this.iconBar=b,this.commands={},this.activeCommand=null,this.events={onStartCommand:new Phaser.Signal,onEndCommand:new Phaser.Signal}}function c(a){return _(a).pluck("commands").flatten().unique().sortBy(function(a){return d[a]||-1}).valueOf()}_.extend(b.prototype,{add:function(a,b){this.commands[a]=b},update:function(){var a=this.activeCommand;a&&a.update()},onSelectionChange:function(a){if(this.selection=a,this.iconBar.clear(),_.isEmpty(a));else{var b=c(a);this.iconBar.display(b)}},onIconSelected:function(a){var b=this.commands[a];b&&(this.events.onStartCommand.dispatch(a),this.activeCommand&&this.activeCommand.cancel(),this.activeCommand=b,b.start(_.once(function(b,c,d){b?console.log(b):_.forEach(this.selection,c,d),this.activeCommand=null,this.iconBar.clearSelection(),this.events.onEndCommand.dispatch(a,b)}.bind(this))))},onIconDeselected:function(a){var b=this.activeCommand;b&&this.commands[a]===b&&(b.cancel(),this.activeCommand=null)}});var d={back:0,move:1,attack:2,defend:3,rally:4,stop:5};a.CommandManager=b}(this),function(a){function b(a,b){this.game=a,this.command=b}b.prototype={start:function(a){this.callback=a;var b=this.indicator=new CommandIndicator(this.game,0,this.command);this.game.add.existing(b),this.game.input.onDown.addOnce(this.onDown,this)},update:function(){this.indicator&&(this.indicator.x=this.game.input.mousePointer.worldX)},cancel:function(){this.destroyIndicator(),this.game.input.onDown.remove(this.onDown,this)},onDown:function(){var a=this.game.input.mousePointer.worldX;this.destroyIndicator(),this.callback(null,function(b){b.send({command:this.command,target:a})},this)},destroyIndicator:function(){this.indicator&&(this.indicator.destroy(),this.indicator=null)}},a.PickXCoordCommand=b}(this),function(a){function b(){}b.prototype={start:function(a){a(null,function(a){a.send({command:"stop"})})}},a.StopCommand=b}(this),function(a){function b(a){Phaser.Sprite.call(this,a,0,0,"invisible"),this.width=a.world.width,this.height=a.world.height,this.inputEnabled=!0,this.bubble=!0,this.changeBubble=!1,this.fixedToCamera=!0,this.events.onClickBackdrop=new Phaser.Signal,this.events.onInputDown.add(function(){console.log("click"),this.bubble&&this.events.onClickBackdrop.dispatch()},this)}b.preload=function(a){a.image("invisible","assets/transparent white.befc4a78.png")},b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{update:function(){this.changeBubble&&(this.bubble=!this.bubble,this.changeBubble=!1)},onStartCommand:function(){this.bubble=!1},onEndCommand:function(){this.changeBubble=!0}}),a.Backdrop=b}(this),function(a){function b(a,b,c){Phaser.Sprite.call(this,a,b,c,"health-bar"),this.frame=0}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.preload=function(a){a.spritesheet("health-bar","assets/health bar.9bea7ae7.png",32,8)},_.extend(b.prototype,{setHp:function(a,b){var c=a/b;this.frame=.25>=c?3:.5>=c?2:.75>=c?1:0}}),a.HealthBar=b}(this),function(a){function b(a){return function(b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b[c]&&"function"==typeof d?Util.override(b,c,d):b[c]=d}}}a.Mixin={create:b}}(this),function(a){var b={WALK_RATE:6,FALL_RATE:12,DEFAULT_WALK_SPEED:50,DEFAULT_JUMP_SPEED:-220,DEFAULT_GRAVITY:350,init:function(){this.animations.add("stand",[1]),this.animations.add("face-left",[4]),this.animations.add("face-right",[7]),this.animations.add("walk-left",[3,4,5,4],b.WALK_RATE,!0),this.animations.add("walk-right",[6,7,8,7],b.WALK_RATE,!0),this.animations.add("falling",[1,4,10,7],b.FALL_RATE,!0),this.animations.play("stand"),game.physics.enable(this,Phaser.Physics.ARCADE),this.anchor.setTo(.5,.5),this.body.collideWorldBounds=!0,this.body.acceleration.y=350,this.gravityDir=Phaser.DOWN},onFloor:function(){switch(this.gravityDir){case Phaser.DOWN:return this.body.onFloor();case Phaser.UP:return this.body.blocked.up}},updateState:function(){switch(this.state){case"standing":if(this.onFloor()){this.body.velocity.x=0;var a=this.destination();if(void 0!==a){var b=a>this.body.x?Phaser.RIGHT:Phaser.LEFT;this.walk(b)}}else this.fall();break;case"walking":if(this.onFloor()){var c=this.destination();void 0!==c?this.dir==Phaser.LEFT?c>this.x?this.walk(Phaser.RIGHT):this.body.blocked.left&&this.jump():this.dir==Phaser.RIGHT&&(c<this.x?this.walk(Phaser.LEFT):this.body.blocked.right&&this.jump()):"none"===this.activity&&this.stand()}else this.fall();break;case"falling":this.onFloor()&&this.stand();break;case"jumping":if(this.gravityDir===Phaser.DOWN&&this.body.velocity.y>0||this.gravityDir===Phaser.UP&&this.body.velocity.y<0)this.fall();else{var c=this.destination();void 0!==c&&(c<this.x?this.left():c>this.y&&this.right())}break;case"cooldown":}},jump:function(){this.changeState("jumping");var a=this.jumpSpeed||b.DEFAULT_JUMP_SPEED;this.body.velocity.y=this.gravityDir===Phaser.DOWN?a:-a},left:function(){this.body.velocity.x=-(this.walkSpeed||b.DEFAULT_WALK_SPEED),this.dir=Phaser.LEFT},right:function(){this.dir=Phaser.RIGHT,this.body.velocity.x=this.walkSpeed||b.DEFAULT_WALK_SPEED},stand:function(){switch(this.changeState("standing"),this.dir){case Phaser.LEFT:this.animations.play("face-left");break;case Phaser.RIGHT:this.animations.play("face-right");break;default:this.animations.play("stand")}},fall:function(){this.changeState("falling")},walk:function(a){switch(a){case Phaser.LEFT:this.changeState("walking"),this.animations.play("walk-left"),this.left();break;case Phaser.RIGHT:this.changeState("walking"),this.animations.play("walk-right"),this.right()}},changeGravity:function(a){this.gravityDir!=a&&(this.gravityDir=a,this.game.time.events.add(300,function(){this.body.acceleration.y=a===Phaser.DOWN?this.DEFAULT_GRAVITY:-this.DEFAULT_GRAVITY,this.scale.y=-this.scale.y},this))},changeState:function(a){this.prevState=this.state,a!=this.state&&(this.onExitState&&this.onExitState(this.state),this.onEnterState&&this.onEnterState(a)),this.state=a},changeActivity:function(a){this.prevActivity=this.activity,a!==this.activity&&(this.onStopActivity&&this.onStopActivity(a),this.onStartActivity&&this.onStartActivity(a)),this.activity=a}};a.Mixin.humanoid=Mixin.create(b)}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,b,c,d)}b.preload=function(a){a.image("1x1-select-box","assets/1x1 selected.fef6b915.png")},b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,_.extend(b.prototype,{createSelectBox:function(){var a=this.selectBox=game.make.sprite(0,0,"1x1-select-box");a.anchor.setTo(.5,.5),a.smoothed=!1,a.visible=!1,this.addChild(a)},createHealthBar:function(){var a=this.height/2,b=this.healthBar=new HealthBar(this.game,0,-a);b.anchor.setTo(.5,1),b.smoothed=!1,b.visible=!1,this.addChild(b)},setHp:function(a,b){void 0!==b&&(this.maxHp=Math.max(1,b)),this.currHp=Math.min(a||0,this.maxHp),this.healthBar.setHp(this.currHp,this.maxHp)},send:function(a){this.onMessage&&this.onMessage(a)},onMessage:function(a){console.log(a)}}),Object.defineProperty(b.prototype,"selected",{get:function(){return this.selectBox.visible},set:function(a){return this.healthBar.visible=this.selectBox.visible=!!a}}),a.Unit=b}(this),function(a){function b(a,b,c,d,e){Unit.call(this,a,b,c,d),this.init(),this.inputEnabled=!0,this.createSelectBox(32,32),this.createHealthBar(),this.activity="none",this.dir=Phaser.NONE,this.blood=e,this.fall()}b.SEEK_TOLERANCE=4,b.WAIT_TOLERANCE=24,b.CLOSE_ENOUGH_X=300,b.CLOSE_ENOUGH_Y=96,b.TOO_FAR_X=400,b.WITHIN_ATTACK_RANGE=24,b.ARROW_SPEED=350,b.ARROW_GRAVITY=450,b.ATTACK_DAMAGE=20,b.TO_HIT_TIME=200,b.COOLDOWN_TIME=1300,b.prototype=Object.create(Unit.prototype),b.prototype.constructor=b,Mixin.humanoid(b.prototype),_.extend(b.prototype,{think:function(){switch(this.activity){case"seeking":Math.abs(this.x-this.target)<b.SEEK_TOLERANCE&&(this.dir=Phaser.NONE,this.changeActivity("none"),this.stand());break;case"waiting":case"patrolling":"waiting"!==this.activity&&Math.abs(this.x-this.target)<(this.seekTolerance||b.SEEK_TOLERANCE)?(this.dir=Phaser.NONE,this.changeActivity("waiting"),this.stand()):"patrolling"!==this.activity&&Math.abs(this.x-this.target)>(this.waitTolerance||b.WAIT_TOLERANCE)&&this.changeActivity("patrolling");var a=this.foes;if(a){var c=Util.findClosest(this,a);c&&(this.actualClosest=c,this.closeEnough(c.value)&&(this.prey=c.value,this.changeActivity("attacking")))}break;case"attacking":this.prey&&(this.prey.exists?this.tooFar(this.prey)?this.changeActivity("patrolling"):this.onFloor()&&this.withinRange(this.prey)&&this.attack(this.prey):(this.prey=null,this.changeActivity("patrolling")))}this.updateState()},destination:function(){switch(this.activity){case"patrolling":case"seeking":return this.target;case"attacking":return this.prey.x}},closeEnough:function(a){var c=this.closeEnoughX||b.CLOSE_ENOUGH_X,d=this.closeEnoughY||b.CLOSE_ENOUGH_Y;return Math.abs(this.x-a.x)<=c&&Math.abs(this.y-a.y)<=d},tooFar:function(a){var c=this.tooFarX||b.TOO_FAR_X,d=this.closeEnoughY||b.CLOSE_ENOUGH_Y;return Math.abs(this.x-a.x)>=c&&Math.abs(this.x-a.x)>=d},withinRange:function(a){var c=this.withinAttackRange||b.WITHIN_ATTACK_RANGE;return Math.abs(a.x-this.x)<=c&&Math.abs(a.y-this.y)<=2},attack:function(){this.nextActivity="patrolling",this.cooldown(b.COOLDOWN_TIME)},cooldown:function(a){this.changeActivity("cooling down"),this.stand(),this.game.time.events.add(a,this.wakeUp,this)},wakeUp:function(){"cooling down"===this.activity&&this.changeActivity(this.nextActivity||"none")},patrol:function(a){this.target=a,this.activity="patrolling"},damage:function(a){this.currHp-=a,this.healthBar.setHp(this.currHp,this.maxHp);var b=this.x,c=this.y;this.currHp<=0?(this.blood.gush(b,c),this.kill(),this.destroy()):this.blood.spray(b,c)},seek:function(a){this.target=a,this.changeActivity("seeking")},stop:function(){this.changeActivity("none"),this.dir=Phaser.NONE,this.target=null},onMessage:function(a){if(_.contains(this.commands,a.command))switch(a.command){case"move":this.seek(a.target);break;case"attack":this.patrol(a.target);break;case"stop":this.stop()}}}),a.Troop=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"knight",e),this.commands=b.COMMANDS,this.setHp(100,100)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","attack","stop"],b.TO_HIT_TIME=200,b.ATTACK_DAMAGE=10,b.COOLDOWN_TIME=600,b.preload=function(a){a.spritesheet("knight","assets/knight.5f1d77ac.png",32,32)},_.extend(b.prototype,{attack:function(a){var c=a.body.x,d=a.body.y;this.body.x<c?(this.dir=Phaser.RIGHT,this.animations.play("face-right")):this.body.x>c&&(this.dir=Phaser.LEFT,this.animations.play("face-left"));var e=new SlashEffect(this.game,c+16,d+16,this.dir);this.game.add.existing(e),this.game.time.events.add(b.TO_HIT_TIME,function(){this.prey.damage(b.ATTACK_DAMAGE)},this),this.nextActivity="patrolling",this.cooldown(b.COOLDOWN_TIME)}}),a.Soldier=b}(this),function(a){function b(a,b,c,d){this.attackDamage=d||Archer.ATTACK_DAMAGE,Phaser.Sprite.call(this,a,b,c,"arrow"),this.anchor.setTo(.5,.5),a.physics.enable(this,Phaser.Physics.ARCADE),this.body.setSize(16,5,0,5),this.body.collideWorldBounds=!0,this.body.bounce.set(.3)}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.FADE_TIME=2500,Util.override(b.prototype,"reset",function(a,b){this.__super(a,b),this.body.collideWorldBounds=!0,this.outOfBoundsKill=!1,this.checkOutOfBounds=!1,this.ghosted=!1;for(var c in this.body.checkCollision)this.body.checkCollision[c]=!0}),b.preload=function(a){a.image("arrow","assets/arrow.45d3f1a7.png")},b.processWorld=function(a){return!a.ghosted},b.collideWorld=function(a){a.ghosted=!0,a.outOfBoundsKill=!0,a.checkOutOfBounds=!0;for(var b in a.body.checkCollision)a.body.checkCollision[b]=!1},b.collideOrc=function(a,b){b.damage(a.attackDamage),a.kill()},_.extend(b.prototype,{update:function(){var a=this.body.velocity;this.rotation=Math.atan2(a.y,a.x)}}),a.Arrow=b}(this),function(a){function b(a,b){void 0===b&&(b=100),Phaser.Group.call(this,a);for(var c=0;b>c;c++){var d=new Arrow(a,0,0);this.add(d),d.kill()}}b.prototype=Object.create(Phaser.Group.prototype),b.prototype.constructor=b,_.extend(b.prototype,{getArrow:function(a,b){var c=this.getFirstDead();return c.reset(a,b),c}}),a.ArrowGroup=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"archer",e),this.commands=b.COMMANDS,this.setHp(75,75),this.withinAttackRange=b.WITHIN_ATTACK_RANGE,this.cooldownTime=b.COOLDOWN_TIME}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","attack","stop"],b.WITHIN_ATTACK_RANGE=200,b.ARROW_SPEED=350,b.ARROW_GRAVITY=450,b.ATTACK_DAMAGE=20,b.COOLDOWN_TIME=1300,b.preload=function(a){a.spritesheet("archer","assets/archer.64e4bc6f.png",32,32)},Mixin.create({attack:function(a){{var c=this.game,d=a.x;a.y}this.x<d?(this.dir=Phaser.RIGHT,this.animations.play("face-right")):this.x>d&&(this.dir=Phaser.LEFT,this.animations.play("face-left"));var e=Util.lobAtPoint(this,a,b.ARROW_SPEED,b.ARROW_GRAVITY);if(void 0!==e){var f=this.arrows.getArrow(this.x,this.y);f.body.acceleration.y=b.ARROW_GRAVITY,e=c.rnd.pick(e),c.physics.arcade.velocityFromRotation(e,b.ARROW_SPEED,f.body.velocity)}this.nextActivity="patrolling",this.cooldown(b.COOLDOWN_TIME)},onMessage:function(a){switch(a.command){case"move":this.seek(a.target);break;case"attack":this.patrol(a.target);break;case"stop":this.stop()}}})(b.prototype),a.Archer=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"peasant",e),this.commands=b.COMMANDS,this.setHp(40,40)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["move","stop"],b.preload=function(a){a.spritesheet("peasant","assets/peasant.4599a146.png",32,32)},a.Peasant=b}(this),function(a){function b(a,b,c,d){this.dir=d,Phaser.Sprite.call(this,a,b,c,"spell-arrow"),this.anchor.setTo(.5,1),a.physics.enable(this,Phaser.Physics.ARCADE),this.animations.add("flutter",[0,1],8)}function c(a){Phaser.Group.call(this,a);for(var c=0;100>c;c++){var d=new b(this.game,0,0,Phaser.NONE);this.add(d),d.kill()}}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.GRAVITY=200,_.extend(b.prototype,{init:function(){var a=this.game.rnd,c=a.realInRange(.25,1);this.scale.x=c,this.scale.y=c,this.dir===Phaser.DOWN?(this.scale.y*=-1,this.body.acceleration.y=b.GRAVITY):this.body.acceleration.y=-b.GRAVITY,this.animations.play("flutter"),this.alpha=0,this.game.add.tween(this).to({alpha:.6},300).to({alpha:.6},1e3).to({alpha:0},150).start(),this.game.time.events.add(1450,this.kill,this)}}),Util.override(b.prototype,"reset",function(a,b){this.__super(a,b),this.init()}),c.prototype=Object.create(Phaser.Group.prototype),c.prototype.constructor=c,c.preload=function(a){a.spritesheet("spell-arrow","assets/spell arrows.369fa48f.png",32,64)},_.extend(c.prototype,{nextArrow:function(a,b,c){var d=this.getFirstDead();return d.dir=c,d.reset(a,b),d}}),a.GravityEffect=c}(this),function(a){function b(a,c,d,e){Phaser.Sprite.call(this,a,c,d,"gravity-field"),this.game=a,this.dir=e,this.game.physics.enable(this,Phaser.Physics.ARCADE),this.anchor.setTo(.5,.5),this.alpha=.6,a.add.tween(this).to({alpha:.2},500,null,!0,0,Number.MAX_VALUE,!0),a.time.events.add(b.DURATION,this.destroy,this)}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.DURATION=3e3,b.preload=function(a){a.image("gravity-field","assets/gravity field.fa3fca9a.png")},b.changeGravity=function(a,b){b.changeGravity(a.dir)},_.extend(b.prototype,{spawn:function(){if(this.exists){var a=this.game.rnd,b=this.width/2,c=a.realInRange(this.x-b,this.x+b),d=this.height/2,e=this.dir===Phaser.UP?this.y+32:this.y-32,f=a.realInRange(e-d,e+d),g=a.integerInRange(50,300);this.effect.nextArrow(c,f,this.dir),this.game.time.events.add(g,this.spawn,this)}}}),a.GravityField=b}(this),function(a){function b(a,b){this.game=a,this.gravityDir=b||Phaser.UP}b.prototype={start:function(a){this.callback=a,this.game.input.onDown.addOnce(this.onDown,this)},update:function(){},cancel:function(){this.game.input.onDown.remove(this.onDown,this)},onDown:function(){var a=this.game.input.mousePointer,b=a.worldX,c=a.worldY;this.callback(null,function(a){a.send({command:"change-gravity",dir:this.gravityDir,target:{x:b,y:c}})},this)}},a.GravitySpellCommand=b}(this),function(a){function b(a,c,d,e){Troop.call(this,a,c,d,"priest",e),this.commands=b.COMMANDS,this.setHp(30,30),this.castTarget=new Phaser.Point,this.castTarget.setTo(-1,-1)}b.prototype=Object.create(Troop.prototype),b.prototype.constructor=b,b.COMMANDS=["gravityUp","gravityDown","move","stop"],b.MIN_CAST_DISTANCE=200,b.preload=function(a){a.spritesheet("priest","assets/priest.b943bb06.png",32,32)},Mixin.create({think:function(){switch(this.activity){case"casting":if(this.castTarget.distance(this)<=b.MIN_CAST_DISTANCE){var a=this.castTarget.x,c=this.castTarget.y;this.cast(a,c)}}this.__super()},destination:function(){return"casting"===this.activity?this.castTarget.x:this.__super()},cast:function(a,b){var c=new GravityField(this.game,a,b,this.spellDir);c.effect=this.gravityEffect,c.spawn(),this.spellsGroup.add(c),this.changeActivity("none"),this.stand()},send:function(a){return"change-gravity"!==a.command?this.__super(a):(this.spellDir=a.dir,this.castTarget.copyFrom(a.target),this.changeActivity("casting"),void 0)}})(b.prototype),a.Priest=b}(this),function(a){function b(a,c,d,e){var f=e===b.MALE?"male-orc":"female-orc";Phaser.Sprite.call(this,a,c,d,f),this.setHp(100,100),this.init(),this.activity="none",this.state="none",this.walkSpeed=60,this.fall()}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.MALE="male",b.FEMALE="female",b.CLOSE_ENOUGH_X=300,b.CLOSE_ENOUGH_Y=96,b.TOO_FAR_X=400,b.WITHIN_ATTACK_RANGE=24,b.ATTACK_DAMAGE=40,b.COOLDOWN_TIME=1e3,b.TO_HIT_TIME=200,b.preload=function(a){a.spritesheet("male-orc","assets/gentleman orc.cb00031e.png",32,32),a.spritesheet("female-orc","assets/lady orc.23c865c5.png",32,32)},Mixin.humanoid(b.prototype),_.extend(b.prototype,{setHp:function(a,b){void 0!==b&&(this.maxHp=Math.max(1,b)),this.currHp=Math.min(this.maxHp,a)},think:function(){var a=this.foes;if(a&&"cooling down"!==this.activity){"hunting"===this.activity&&(this.prey?this.tooFar(this.prey)&&this.changeActivity("none"):(console.log("error: hunting nothing"),this.changeActivity("none")));var b=Util.findClosest(this,a);b&&(this.actualClosest=b,this.closeEnough(b.value)&&"hunting"!==this.activity&&(this.prey=b.value,this.changeActivity("hunting")))}switch(this.activity){case"hunting":this.prey?this.prey.exists?this.onFloor()&&this.withinRange(this.prey)&&this.attack():(this.prey=null,this.changeActivity("none")):(console.log("error: hunting nothing"),this.changeActivity("none"))}this.updateState()},destination:function(){if("hunting"===this.activity){if(this.prey)return this.prey.x;this.changeActivity("none"),console.log("error: hunting nothing")}return void 0},closeEnough:function(a){return Math.abs(this.x-a.x)<=b.CLOSE_ENOUGH_X&&Math.abs(this.y-a.y)<=b.CLOSE_ENOUGH_Y},tooFar:function(a){return Math.abs(this.x-a.x)>=b.TOO_FAR_X&&Math.abs(this.x-a.x)>=b.CLOSE_ENOUGH_Y},withinRange:function(a){return Math.abs(a.x-this.x)<=b.WITHIN_ATTACK_RANGE&&Math.abs(a.y-this.y)<=2},attack:function(){if(this.prey){var a=this.prey.body.x,c=this.prey.body.y;this.body.x<a?(this.dir=Phaser.RIGHT,this.animations.play("face-right")):this.body.x>a&&(this.dir=Phaser.LEFT,this.animations.play("face-left"));var d=new SlashEffect(this.game,a+16,c+16,this.dir);this.game.add.existing(d),this.game.time.events.add(b.TO_HIT_TIME,function(){this.prey.damage(b.ATTACK_DAMAGE)},this),this.cooldown(b.COOLDOWN_TIME)}else this.changeActivity("none"),console.log("error: attacking nothing")},cooldown:function(a){this.changeActivity("cooling down"),this.stand(),this.game.time.events.add(a,this.wakeUp,this)},wakeUp:function(){"cooling down"===this.activity&&this.changeActivity("none")},damage:function(a){this.currHp-=a;var b=this.x,c=this.y;this.currHp<=0?(this.blood.gush(b,c),this.destroy()):this.blood.spray(b,c)}}),a.Orc=b}(this),function(a){function b(a,b){var c=this.emitter=a.add.emitter(0,0,100);c.makeParticles(b),c.gravity=350}b.preload=function(a){a.image("man-blood","assets/manblood.24438e51.png"),a.image("orc-blood","assets/orcblood.5fd1d11b.png")},b.prototype={gush:function(a,b){this.emit(a,b,30)},spray:function(a,b){this.emit(a,b,6)},emit:function(a,b,c){var d=this.emitter;d.x=a,d.y=b,d.start(!0,500,null,c)}},a.BloodSpray=b}(this),function(a){function b(a,b,c,d){Phaser.Sprite.call(this,a,b,c,"slash-effect"),this.anchor.setTo(.5,.5),d===Phaser.RIGHT&&(this.scale.x=-1),this.animations.add("slash",[0,1,2,3],10),this.animations.play("slash",null,!1,!0)}b.prototype=Object.create(Phaser.Sprite.prototype),b.prototype.constructor=b,b.preload=function(a){a.spritesheet("slash-effect","assets/slash.961ea3bd.png",32,32)},a.SlashEffect=b}(this),function(a){function b(a,c){this.game=a,this.terrain=c,this.units=[];var d=c.width,e=c.height,f=this.fogMap=a.add.tilemap();f.addTilesetImage("fog-of-war-tiles");for(var g=(this.fogLayer=f.create("fog",d,e,32,32),0);d>g;g++)for(var h=0;e>h;h++)f.putTile(b.DARK_TILE,g,h)}b.preload=function(a){a.image("fog-of-war-tiles","assets/fog of war tiles.e1f5b010.png")},b.DARK_TILE=11,b.TRANSPARENT_TILE=12,b.DEFAULT_SIGHT_RANGE=200,b.prototype={track:function(a){if(_.findIndex(this.units,{unit:a})<0){var c=this.fogLayer,d={x:c.getTileX(a.x),y:c.getTileY(a.y),r:a.sightRange||b.DEFAULT_SIGHT_RANGE,unit:a};a.events.onKilled.addOnce(this.onKilled,this),this.setVisible(d.x,d.y,d.r,!0),this.units.push(d)}},update:function(){var a,c,d,e=this.fogLayer;_.forEach(this.units,function(f){a=e.getTileX(f.unit.x),c=e.getTileY(f.unit.y),d=f.unit.sightRange||b.DEFAULT_SIGHT_RANGE,(a!==f.x||c!==f.y||d!==f.r)&&(this.setVisible(f.x,f.y,f.r,!1),this.setVisible(a,c,d,!0),f.x=a,f.y=c,f.r=d)},this)},setVisible:function(a,b,c,d){var e,f,g,h,i,j=this.fogMap,k=this.fogLayer,l=k.getTileX(32*a+c)-a,m=a-l,n=b-l,o=a+l,p=b+l;for(e=m;o>=e;e++)for(f=n;p>=f;f++)e>=0&&e<j.width&&f>=0&&f<j.height&&(g=e-a,h=f-b,i=Math.sqrt(g*g+h*h),l>=i&&(d?this.addLight(e,f):this.removeLight(e,f)))},addLight:function(a,c){var d=this.fogMap,e=this.fogLayer,f=d.getTile(a,c);void 0===f.lights||f.lights<=0?(f.index=b.TRANSPARENT_TILE,f.lights=1,e.dirty=!0):f.lights++},removeLight:function(a,b){var c=this.fogMap,d=this.fogLayer,e=c.getTile(a,b);if(e.lights&&(e.lights--,e.lights<=0)){var f=this.terrain.getTile(a,b);e.index=f?f.index-1:0,d.dirty=!0}},onKilled:function(a){var b=this.units,c=_.findIndex(b,{unit:a}),d=b[c];this.setVisible(d.x,d.y,d.r,!1),this.units.splice(c,1)}},a.FogOfWar=b}(this),function(a){function b(a,b,c,d,e,f){this.game=a,this.humans=b,this.orcs=c,this.manblood=new BloodSpray(a,"man-blood"),this.orcblood=new BloodSpray(a,"orc-blood"),this.arrows=d,this.spells=e,this.gravityEffect=f}function c(a){return 32*a+16}function d(a){return 32*a+16}b.prototype={soldier:function(a,b){var a=d(a),b=c(b),e=new Soldier(this.game,a,b,this.manblood);return e.foes=this.orcs,e},archer:function(a,b){var a=d(a),b=c(b),e=new Archer(this.game,a,b,this.manblood);return e.foes=this.orcs,e.arrows=this.arrows,e},peasant:function(a,b){var a=d(a),b=c(b);return new Peasant(this.game,a,b,this.manblood)},priest:function(a,b){var a=d(a),b=c(b),e=new Priest(this.game,a,b,this.manblood);return e.gravityEffect=this.gravityEffect,e.spellsGroup=this.spells,e},orc:function(a,b){var a=d(a),b=c(b),e=this.game.rnd.pick(["male","female"]),f=new Orc(this.game,a,b,e);return f.foes=this.humans,f.blood=this.orcblood,f}},a.Spawn=b}(this),function(a){function b(){}b.prototype={preload:function(){this.load.image("loading-bar-overlay","assets/loading-bar-overlay.ceb049f0.png"),this.load.image("loading-bar","assets/loading-bar.defc2430.png")},create:function(){this.game.state.start("preloader")}},a.Boot=b}(this),function(a){function b(){}b.FADE_OUT_TIME=250,b.STAY_DARK_TIME=100,b.NEXT_STATE="game",b.prototype={preload:function(){var a=this.load,b=this.add;this.bar=b.sprite(303,281,"loading-bar"),this.overlay=b.sprite(298,276,"loading-bar-overlay"),a.onLoadComplete.addOnce(this.onLoadComplete,this),a.setPreloadSprite(this.bar),Game.preload(a),Unit.preload(a),Soldier.preload(a),Archer.preload(a),Peasant.preload(a),Priest.preload(a),Orc.preload(a),IconBar.preload(a),CommandIndicator.preload(a),Backdrop.preload(a),HealthBar.preload(a),BloodSpray.preload(a),SlashEffect.preload(a),Arrow.preload(a),GravityField.preload(a),GravityEffect.preload(a),FogOfWar.preload(a)},onLoadComplete:function(){this.add.tween(this.bar).to({alpha:0},b.FADE_OUT_TIME).start().onComplete.addOnce(function(){this.time.events.add(b.STAY_DARK_TIME,function(){this.game.state.start(b.NEXT_STATE)},this)},this),this.add.tween(this.overlay).to({alpha:0},b.FADE_OUT_TIME).start()}},a.Preloader=b}(this),function(a){function b(){}b.SCROLL_MARGIN=50,b.CAMERA_SPEED=10;for(var c={},d=0;34>d;d++)c[d]=d-1;b.preload=function(a){a.tilemap("test-map-0","assets/test-map-1.6b80c2ce.json",void 0,Phaser.Tilemap.TILED_JSON),a.image("placeholder-tiles","assets/placeholder tiles.2c479a50.png")},b.prototype={create:function(){var a=this.add,c=this.game,d=this.game.physics;this.stage.backgroundColor="#6495ED",d.startSystem(Phaser.Physics.ARCADE);var e=this.backdrop=new Backdrop(c);c.add.existing(e);var f=this.map=a.tilemap("test-map-0"),g=this.layer=f.createLayer("terrain");f.addTilesetImage("terrain","placeholder-tiles"),f.setCollisionBetween(2,10,!0),g.resizeWorld();var h=this.iconBar=new IconBar(c);h.x=b.SCROLL_MARGIN,h.y=600-(b.SCROLL_MARGIN+64),h.fixedToCamera=!0;var i=this.selections=new SelectionManager(c),j=this.commands=new CommandManager(c,h);j.add("move",new PickXCoordCommand(c,"move")),j.add("attack",new PickXCoordCommand(c,"attack")),j.add("defend",new PickXCoordCommand(c,"defend")),j.add("stop",new StopCommand),j.add("gravityUp",new GravitySpellCommand(c,Phaser.UP)),j.add("gravityDown",new GravitySpellCommand(c,Phaser.DOWN)),i.events.onSelectionChange.add(j.onSelectionChange,j),h.events.onIconSelected.add(j.onIconSelected,j),h.events.onIconDeselected.add(j.onIconDeselected,j),e.events.onClickBackdrop.add(i.onClickBackdrop,i),j.events.onStartCommand.add(e.onStartCommand,e),j.events.onEndCommand.add(e.onEndCommand,e);var k=this.arrows=new ArrowGroup(c),l=this.gravityEffect=new GravityEffect(c),m=this.spells=c.make.group(),n=this.humans=a.group(),o=this.orcs=a.group();spawn=new Spawn(c,n,o,k,m,l),n.add(spawn.soldier(29,16)),n.add(spawn.soldier(31,16)),n.add(spawn.archer(36,16)),n.add(spawn.peasant(39,16)),n.add(spawn.priest(40,16)),n.forEach(function(a){a.events.onInputDown.add(i.onInputDown,i)},this),o.add(spawn.orc(12,25)),o.add(spawn.orc(13,25)),o.add(spawn.orc(14,25)),o.add(spawn.orc(24,18)),c.add.existing(k),c.add.existing(m),c.add.existing(l);var p=this.fog=new FogOfWar(c,f);n.forEach(p.track,p),c.world.bringToTop(h),c.camera.x=1e3,c.camera.y=222},update:function(){var a=this.humans,c=this.orcs,d=this.arrows,e=this.spells,f=this.game.physics,g=this.input.mousePointer.position;g.x<b.SCROLL_MARGIN?this.camera.x+=-b.CAMERA_SPEED:g.x>this.game.width-b.SCROLL_MARGIN&&(this.camera.x+=b.CAMERA_SPEED),g.y<b.SCROLL_MARGIN?this.camera.y+=-b.CAMERA_SPEED:g.y>this.game.height-b.SCROLL_MARGIN&&(this.camera.y+=b.CAMERA_SPEED),f.arcade.collide(a,this.layer),f.arcade.collide(c,this.layer),f.arcade.collide(d,this.layer,Arrow.collideWorld,Arrow.processWorld),f.arcade.overlap(d,c,Arrow.collideOrc),f.arcade.overlap(e,c,GravityField.changeGravity),f.arcade.overlap(e,a,GravityField.changeGravity),a.callAll("think"),c.callAll("think"),this.fog.update(),this.commands.update()
},onIconSelected:function(a){console.log('entering "'+a+'"');var b=this.indicator=new CommandIndicator(this.game,0,a);b.fixToInput=!0,game.add.existing(b)},onIconDeselected:function(a){console.log('exiting "'+a+'"'),this.indicator&&(this.indicator.destroy(),this.indicator=null)}},a.Game=b}(this);var game=new Phaser.Game(800,600,Phaser.AUTO,"game-container");game.state.add("boot",Boot),game.state.add("preloader",Preloader),game.state.add("game",Game),game.state.start("boot");